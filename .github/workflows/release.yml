name: Release

on:
  release:
    types: [created]

permissions:
  contents: write
  packages: write

jobs:
  releases-matrix:
    name: Release Go Binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Build and publish in parallel: linux/amd64, linux/arm64, darwin/amd64, darwin/arm64
        goos: [linux, darwin]
        goarch: [amd64, arm64]
    env:
      CI: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install dependencies
        run: |
          go mod download

      - name: Build CLI binary
        run: |
          mkdir -p dist
          VERSION=${{ github.event.release.tag_name }}
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LDFLAGS="-X github.com/maintc/wipe-cli/internal/version.Version=${VERSION} \
                   -X github.com/maintc/wipe-cli/internal/version.GitCommit=${COMMIT} \
                   -X github.com/maintc/wipe-cli/internal/version.BuildDate=${BUILD_DATE}"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "${LDFLAGS}" -o dist/wipe ./cmd/wipe

      - name: Build daemon binary
        run: |
          VERSION=${{ github.event.release.tag_name }}
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LDFLAGS="-X github.com/maintc/wipe-cli/internal/version.Version=${VERSION} \
                   -X github.com/maintc/wipe-cli/internal/version.GitCommit=${COMMIT} \
                   -X github.com/maintc/wipe-cli/internal/version.BuildDate=${BUILD_DATE}"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "${LDFLAGS}" -o dist/wiped ./cmd/wiped

      - name: Package binaries
        run: |
          platform="${{ matrix.goos }}-${{ matrix.goarch }}"
          zip_file="wipe-cli-${platform}.zip"
          cd dist
          zip $zip_file wipe* wiped*
          cd ..

      - name: Upload to Release
        uses: actions/github-script@v6
        env:
          RELEASE_ID: ${{ github.event.release.id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs').promises;
            const path = `dist/wipe-cli-${{ matrix.goos }}-${{ matrix.goarch }}.zip`;
            const data = await fs.readFile(path);
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.RELEASE_ID,
              name: `wipe-cli-${{ matrix.goos }}-${{ matrix.goarch }}.zip`,
              data,
              headers: {
                'content-type': 'application/zip',
                'content-length': data.length
              }
            });

